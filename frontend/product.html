<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>상품 상세</title>

    <style>
        body {
            font-family: "Noto Sans KR", sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
        }

        .detail-box {
            width: 900px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 40px;
        }

        .detail-box img {
            width: 380px;
            height: 380px;
            border-radius: 12px;
            object-fit: cover;
            background: #eee;
        }

        .info {
            flex: 1;
            padding-top: 20px;
        }

        .info h2 {
            margin-bottom: 20px;
        }

        .button-group {
            margin-top: 25px;
            display: flex;
            gap: 12px;
        }

        .button-group button {
            flex: 1;
            padding: 14px;
            background: #6a5acd;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.15s;
        }

        .button-group .home-btn {
            background: #555;
        }

        .button-group .home-btn:hover {
            background: #333;
        }

        .quantity-box {
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .quantity-box input {
            padding: 6px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 80px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 300px;
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .modal-btn.purple {
            background: #6a5acd;
            color: white;
        }
    </style>
</head>

<body>

<div id="cartModal" class="modal">
    <div class="modal-content">
        <p style="font-size:18px; margin-bottom:20px;">장바구니에 담았습니다!</p>
        <button id="continueBtn" class="modal-btn">쇼핑 계속하기</button>
        <button id="goCartBtn" class="modal-btn purple">장바구니로 이동</button>
    </div>
</div>

<div class="detail-box">
    <img id="productImg">

    <div class="info">
        <h2 id="productName"></h2>
        <p id="productDescription" style="margin-top:20px; color:#555; line-height:1.5;"></p>
        <p id="productPrice"></p>
        <p id="productStock"></p>
        <p id="productCategory"></p>

        <div class="quantity-box">
            <label for="qty">수량:</label>
            <input id="qty" type="number" value="1" min="1">
        </div>

        <div class="button-group">
            <button onclick="buy()">구매하기</button>
            <button onclick="addToCartFromDetail()">장바구니 담기</button>
            <button class="home-btn" onclick="location.href='index.html'">홈으로</button>
        </div>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const productId = params.get("id");

    const productImages = {
        "3D 고양이": "images/cat.gif",
        "3D 강아지": "images/dog1.jpeg",
        "레제 티셔츠": "images/tshirt.jpeg",
        "레제 쵸커": "images/choker.png",
        "에어컨": "images/aircon.jpeg",
        "책상": "images/desk.jpeg"
    };


    async function buy() {
        const userId = localStorage.getItem("loginUser");
        const quantity = Number(document.getElementById("qty").value);

        if (!userId) {
            alert("로그인 후 이용해주세요.");
            return;
        }

        const res = await fetch("http://localhost:8080/purchase", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                memberId: userId,
                productId: productId,
                quantity: quantity
            })
        });

        if (!res.ok) {
            const msg = await res.text();
            alert("구매 실패: " + msg);
            return;
        }

        const data = await res.json();
        localStorage.setItem("point", data.remainPoint);
        alert("구매 완료! 남은 포인트: " + data.remainPoint);
    }

    function addToCartFromDetail() {
        const userId = localStorage.getItem("loginUser");

        if (!userId) {
            alert("로그인이 필요합니다!");
            location.href = "login.html";
            return;
        }

        const quantity = Number(document.getElementById("qty").value);
        const cartKey = `cart_${userId}`;

        const cart = JSON.parse(localStorage.getItem(cartKey)) || {};
        cart[productId] = (cart[productId] || 0) + quantity;

        localStorage.setItem(cartKey, JSON.stringify(cart));

        document.getElementById("cartModal").style.display = "flex";
    }

    document.addEventListener("DOMContentLoaded", () => {

        document.getElementById("continueBtn").onclick = () => {
            window.location.href = "index.html";
        };

        document.getElementById("goCartBtn").onclick = () => {
            window.location.href = "cart.html";
        };
    });

    async function loadDetail() {
        const res = await fetch(`http://localhost:8080/products/${productId}`);

        if (!res.ok) {
            alert("상품을 불러올 수 없습니다.");
            return;
        }

        const p = await res.json();

        document.getElementById("productImg").src = productImages[p.name] || "images/default.png";
        document.getElementById("productDescription").textContent = p.description || "상품 설명이 없습니다.";
        document.getElementById("productName").textContent = p.name;
        document.getElementById("productPrice").textContent = `가격: ${p.price.toLocaleString()}원`;
        document.getElementById("productStock").textContent = `재고: ${p.stock}`;
        document.getElementById("productCategory").textContent = `카테고리: ${p.category}`;
    }

    loadDetail();
</script>

</body>
</html>